#!/usr/bin/env python3
"""
Teste de Autentica√ß√£o - Employee - Portal KNN

Este script testa especificamente o fluxo de autentica√ß√£o para usu√°rios Employee,
incluindo endpoints espec√≠ficos e permiss√µes de funcion√°rios.

Autor: Sistema de Testes KNN
Data: 2025-01-06
"""

import sys
from datetime import datetime

from base_auth_test import BaseAuthenticationTester


class EmployeeAuthenticationTester(BaseAuthenticationTester):
    """Testador espec√≠fico para autentica√ß√£o de Employee."""

    def __init__(self):
        """Inicializa o testador de Employee."""
        super().__init__()
        self.entity_type = "employee"

    def test_employee_specific_endpoints(self) -> list[dict]:
        """
        Testa endpoints espec√≠ficos para Employee.

        Returns:
            Lista com resultados dos testes de endpoints
        """
        self.print_header("TESTANDO ENDPOINTS ESPEC√çFICOS DE EMPLOYEE")

        employee_endpoints = [
            "/users/me",
            "/employees/profile",
            "/employees/dashboard",
            "/employees/tasks",
            "/employees/schedule",
            "/employees/reports",
            "/employees/notifications",
            "/employees/students",
            "/employees/courses",
            "/employees/attendance",
            "/employees/performance",
        ]

        endpoint_results = []

        for endpoint in employee_endpoints:
            self.print_step(f"Testando endpoint: {endpoint}")
            success, data = self.test_authenticated_endpoint(endpoint)

            result = {
                "endpoint": endpoint,
                "success": success,
                "timestamp": datetime.now().isoformat(),
            }

            if success and data:
                result["data_keys"] = (
                    list(data.keys()) if isinstance(data, dict) else "non-dict"
                )
                result["data_size"] = len(str(data))

            endpoint_results.append(result)

        successful_endpoints = sum(1 for r in endpoint_results if r["success"])
        total_endpoints = len(endpoint_results)

        self.print_step(
            f"Endpoints testados: {successful_endpoints}/{total_endpoints} bem-sucedidos",
            "SUCCESS" if successful_endpoints > 0 else "WARNING",
        )

        return endpoint_results

    def test_employee_permissions(self) -> dict:
        """
        Testa permiss√µes espec√≠ficas de Employee.

        Returns:
            Dicion√°rio com resultado do teste de permiss√µes
        """
        self.print_header("TESTANDO PERMISS√ïES DE EMPLOYEE")

        permissions_result = {
            "can_access_employee_dashboard": False,
            "can_view_tasks": False,
            "can_view_schedule": False,
            "can_view_reports": False,
            "can_manage_students": False,
            "can_view_courses": False,
            "timestamp": datetime.now().isoformat(),
        }

        # Testar acesso ao dashboard do funcion√°rio
        dashboard_success, _ = self.test_authenticated_endpoint("/employees/dashboard")
        permissions_result["can_access_employee_dashboard"] = dashboard_success

        # Testar acesso a tarefas
        tasks_success, _ = self.test_authenticated_endpoint("/employees/tasks")
        permissions_result["can_view_tasks"] = tasks_success

        # Testar acesso ao cronograma
        schedule_success, _ = self.test_authenticated_endpoint("/employees/schedule")
        permissions_result["can_view_schedule"] = schedule_success

        # Testar acesso a relat√≥rios
        reports_success, _ = self.test_authenticated_endpoint("/employees/reports")
        permissions_result["can_view_reports"] = reports_success

        # Testar gerenciamento de estudantes
        students_success, _ = self.test_authenticated_endpoint("/employees/students")
        permissions_result["can_manage_students"] = students_success

        # Testar acesso a cursos
        courses_success, _ = self.test_authenticated_endpoint("/employees/courses")
        permissions_result["can_view_courses"] = courses_success

        # Resumo das permiss√µes
        total_permissions = 6
        granted_permissions = sum(
            1
            for key, value in permissions_result.items()
            if key.startswith("can_") and value
        )

        self.print_step(
            f"Permiss√µes concedidas: {granted_permissions}/{total_permissions}",
            "SUCCESS" if granted_permissions > 0 else "WARNING",
        )

        return permissions_result

    def test_employee_operational_features(self) -> dict:
        """
        Testa funcionalidades operacionais espec√≠ficas para Employee.

        Returns:
            Dicion√°rio com resultado dos testes operacionais
        """
        self.print_header("TESTANDO FUNCIONALIDADES OPERACIONAIS - EMPLOYEE")

        operational_result = {
            "can_track_attendance": False,
            "can_view_performance": False,
            "can_access_notifications": False,
            "can_view_profile": False,
            "timestamp": datetime.now().isoformat(),
        }

        # Testar controle de presen√ßa
        attendance_success, _ = self.test_authenticated_endpoint(
            "/employees/attendance"
        )
        operational_result["can_track_attendance"] = attendance_success

        # Testar acesso a performance
        performance_success, _ = self.test_authenticated_endpoint(
            "/employees/performance"
        )
        operational_result["can_view_performance"] = performance_success

        # Testar acesso a notifica√ß√µes
        notifications_success, _ = self.test_authenticated_endpoint(
            "/employees/notifications"
        )
        operational_result["can_access_notifications"] = notifications_success

        # Testar acesso ao perfil
        profile_success, _ = self.test_authenticated_endpoint("/employees/profile")
        operational_result["can_view_profile"] = profile_success

        # Resumo das funcionalidades operacionais
        total_tests = 4
        successful_tests = sum(
            1
            for key, value in operational_result.items()
            if key.startswith("can_") and value
        )

        self.print_step(
            f"Funcionalidades operacionais: {successful_tests}/{total_tests} bem-sucedidas",
            "SUCCESS" if successful_tests > 0 else "WARNING",
        )

        return operational_result

    def validate_employee_access_level(self) -> dict:
        """
        Valida o n√≠vel de acesso do funcion√°rio (intermedi√°rio entre student e admin).

        Returns:
            Dicion√°rio com resultado da valida√ß√£o de n√≠vel de acesso
        """
        self.print_header("VALIDANDO N√çVEL DE ACESSO - EMPLOYEE")

        access_level_result = {
            "has_intermediate_access": True,
            "cannot_access_admin_functions": True,
            "can_access_student_management": False,
            "security_validation": "passed",
            "timestamp": datetime.now().isoformat(),
        }

        # Obter informa√ß√µes do usu√°rio
        user_info = self.get_user_info_from_me_endpoint()

        if user_info:
            employee_id = user_info.get("id")
            if employee_id:
                self.print_step(f"üÜî Validando acesso para Employee ID: {employee_id}")
                access_level_result["employee_id"] = employee_id
            else:
                self.print_step("‚ö†Ô∏è ID do funcion√°rio n√£o encontrado", "WARNING")
                access_level_result["security_validation"] = "warning"

        # Testar se N√ÉO consegue acessar fun√ß√µes administrativas cr√≠ticas
        admin_users_success, _ = self.test_authenticated_endpoint("/admin/users")
        admin_settings_success, _ = self.test_authenticated_endpoint("/admin/settings")

        if admin_users_success or admin_settings_success:
            self.print_step(
                "‚ùå FALHA DE SEGURAN√áA: Funcion√°rio tem acesso a fun√ß√µes administrativas cr√≠ticas!",
                "ERROR",
            )
            access_level_result["cannot_access_admin_functions"] = False
            access_level_result["security_validation"] = "failed"

        # Testar se PODE acessar gerenciamento de estudantes (fun√ß√£o intermedi√°ria)
        students_success, _ = self.test_authenticated_endpoint("/employees/students")
        if students_success:
            self.print_step(
                "‚úÖ Funcion√°rio pode gerenciar estudantes (acesso intermedi√°rio correto)",
                "SUCCESS",
            )
            access_level_result["can_access_student_management"] = True

        # Testar se N√ÉO consegue acessar dados de parceiros
        partner_access_success, _ = self.test_authenticated_endpoint(
            "/partners/dashboard"
        )
        if partner_access_success:
            self.print_step(
                "‚ùå FALHA DE SEGURAN√áA: Funcion√°rio tem acesso a dados de parceiros!",
                "ERROR",
            )
            access_level_result["has_intermediate_access"] = False
            access_level_result["security_validation"] = "failed"

        if access_level_result["security_validation"] == "passed":
            self.print_step(
                "‚úÖ Valida√ß√£o de seguran√ßa: N√≠vel de acesso intermedi√°rio funcionando corretamente",
                "SUCCESS",
            )

        return access_level_result

    def run_complete_employee_test(self) -> dict:
        """
        Executa o teste completo de autentica√ß√£o para Employee.

        Returns:
            Dicion√°rio com resultado completo do teste
        """
        self.print_header("TESTE COMPLETO DE AUTENTICA√á√ÉO - EMPLOYEE")

        # Executar fluxo b√°sico de autentica√ß√£o
        basic_result = self.run_basic_auth_flow("funcionario_teste")

        if not basic_result["success"]:
            self.print_step(f"Falha no fluxo b√°sico: {basic_result['error']}", "ERROR")
            return basic_result

        # Obter informa√ß√µes detalhadas do usu√°rio
        user_info = self.get_user_info_from_me_endpoint()

        # Testar endpoints espec√≠ficos de Employee
        endpoint_results = self.test_employee_specific_endpoints()

        # Testar permiss√µes de Employee
        permissions_result = self.test_employee_permissions()

        # Testar funcionalidades operacionais
        operational_result = self.test_employee_operational_features()

        # Validar n√≠vel de acesso
        access_level_result = self.validate_employee_access_level()

        # Compilar resultado final
        complete_result = {
            **basic_result,
            "user_info": user_info,
            "endpoint_results": endpoint_results,
            "permissions": permissions_result,
            "operational_features": operational_result,
            "access_level_validation": access_level_result,
            "total_endpoints_tested": len(endpoint_results),
            "successful_endpoints": sum(1 for r in endpoint_results if r["success"]),
            "test_completed_at": datetime.now().isoformat(),
        }

        # Salvar relat√≥rio
        report_path = self.save_test_report([complete_result], "employee")

        # Resumo final
        self.print_header("RESUMO DO TESTE - EMPLOYEE")
        self.print_step(
            f"‚úÖ Autentica√ß√£o Firebase: {'Sucesso' if basic_result['success'] else 'Falha'}"
        )
        self.print_step(
            f"‚úÖ Login Backend: {'Sucesso' if basic_result['success'] else 'Falha'}"
        )
        self.print_step(
            f"üìä Endpoints testados: {complete_result['successful_endpoints']}/{complete_result['total_endpoints_tested']}"
        )
        self.print_step(
            f"üîí Valida√ß√£o de seguran√ßa: {access_level_result['security_validation'].upper()}"
        )

        if user_info:
            self.print_step(f"üë§ Usu√°rio: {user_info.get('email', 'N/A')}")
            self.print_step(f"üÜî ID: {user_info.get('id', 'N/A')}")
            self.print_step(f"üë• Role: {user_info.get('role', 'N/A')}")
            self.print_step(f"üíº Employee ID: {user_info.get('employee_id', 'N/A')}")

        self.print_step(f"üìÑ Relat√≥rio salvo: {report_path}")

        return complete_result


def main():
    """Fun√ß√£o principal para execu√ß√£o do teste de Employee."""
    print("üîê Iniciando Teste de Autentica√ß√£o - EMPLOYEE")
    print(f"‚è∞ Hor√°rio: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")

    try:
        tester = EmployeeAuthenticationTester()
        result = tester.run_complete_employee_test()

        if result["success"]:
            print("\nüéâ Teste de Employee conclu√≠do com SUCESSO!")
            sys.exit(0)
        else:
            print(
                f"\n‚ùå Teste de Employee FALHOU: {result.get('error', 'Erro desconhecido')}"
            )
            sys.exit(1)

    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Teste interrompido pelo usu√°rio")
        sys.exit(1)
    except Exception as e:
        print(f"\nüí• Erro inesperado no teste: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()
