name: Valida√ß√£o de Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validar Pull Request
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Validar t√≠tulo do PR
      run: |
        if [[ ! "${{ github.event.pull_request.title }}" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: ]]; then
          echo "‚ùå T√≠tulo do PR deve seguir o padr√£o: tipo(escopo): descri√ß√£o"
          echo "Exemplos: feat(api): adicionar endpoint de parceiros"
          echo "         fix(auth): corrigir valida√ß√£o de token"
          exit 1
        fi
        
    - name: Verificar arquivos modificados
      run: |
        echo "üìÅ Arquivos modificados neste PR:"
        git diff --name-only origin/${{ github.base_ref }}..HEAD
        
    - name: Verificar se h√° testes para novos arquivos
      run: |
        NEW_PY_FILES=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}..HEAD | grep "src/.*\.py$" || true)
        if [ ! -z "$NEW_PY_FILES" ]; then
          echo "üß™ Novos arquivos Python detectados. Verificando testes..."
          for file in $NEW_PY_FILES; do
            test_file="tests/test_$(basename $file)"
            if [ ! -f "$test_file" ]; then
              echo "‚ö†Ô∏è  Considere adicionar testes para: $file"
            fi
          done
        fi
        
    - name: Verificar tamanho do PR
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | wc -l)
        CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}..HEAD | tail -1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc || echo "0")
        
        echo "üìä Estat√≠sticas do PR:"
        echo "   - Arquivos modificados: $CHANGED_FILES"
        echo "   - Linhas alteradas: $CHANGED_LINES"
        
        if [ $CHANGED_FILES -gt 20 ]; then
          echo "‚ö†Ô∏è  PR grande detectado ($CHANGED_FILES arquivos). Considere dividir em PRs menores."
        fi
        
        if [ $CHANGED_LINES -gt 500 ]; then
          echo "‚ö†Ô∏è  Muitas altera√ß√µes detectadas ($CHANGED_LINES linhas). Considere dividir em PRs menores."
        fi